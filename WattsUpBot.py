import asyncio
import os
from aiogram import Bot, Dispatcher, types
from aiogram.filters import CommandStart
from openai import OpenAI

# ================== –ù–ê–°–¢–†–û–ô–ö–ò ==================

BOT_TOKEN = "PASTE_TELEGRAM_TOKEN"
OPENAI_API_KEY = "PASTE_OPENAI_KEY"

client = OpenAI(api_key=OPENAI_API_KEY)

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# ================== –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –ü–û –¢–ï–ú–ê–ú ==================

EV_KEYWORDS = [
    "—ç–ª–µ–∫—Ç—Ä–æ", "—ç–ª–µ–∫—Ç—Ä–æ–∫–∞—Ä", "—ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª—å",
    "–∑–∞—Ä—è–¥", "–±–∞—Ç–∞—Ä", "–∫–≤—Ç", "–∫–º",
    "tesla", "nissan", "leaf", "model",
    "byd", "zeekr", "xiaomi", "ev",
    "–∑–∞–ø–∞—Å —Ö–æ–¥–∞", "cha", "ccs"
]

def is_ev_related(text: str) -> bool:
    text = text.lower()
    return any(word in text for word in EV_KEYWORDS)

# ================== –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢ ==================

SYSTEM_PROMPT = """
–¢—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª—è–º –∏ –ø–æ–µ–∑–¥–∫–∞–º.

–¢—ã –æ—Ç–≤–µ—á–∞–µ—à—å –¢–û–õ–¨–ö–û –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å:
- —ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª—è–º–∏
- –∑–∞–ø–∞—Å–æ–º —Ö–æ–¥–∞
- –±–∞—Ç–∞—Ä–µ—è–º–∏ –∏ –∑–∞—Ä—è–¥–∫–æ–π
- –º–∞—Ä—à—Ä—É—Ç–∞–º–∏ –ø–æ–µ–∑–¥–æ–∫
- –∑–∞—Ä—è–¥–Ω—ã–º–∏ —Å—Ç–∞–Ω—Ü–∏—è–º–∏
- –ø–æ–µ–∑–¥–∫–∞–º–∏ –ø–æ –°—Ç—Ä–∞–Ω–∞–º –∏ –ì–æ—Ä–æ–¥–∞–º

–¢–í–û–Ø –õ–û–ì–ò–ö–ê –†–ê–ë–û–¢–´:
1. –û–ø—Ä–µ–¥–µ–ª–∏ –º–æ–¥–µ–ª—å —ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª—è
2. –û–ø—Ä–µ–¥–µ–ª–∏ —Ç–æ—á–∫—É —Å—Ç–∞—Ä—Ç–∞ –∏ —Ç–æ—á–∫—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
3. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Äî –∑–∞–¥–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å
4. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ:
   - –æ—Ü–µ–Ω–∏ –∑–∞–ø–∞—Å —Ö–æ–¥–∞
   - –æ—Ü–µ–Ω–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
   - —Å–∫–∞–∂–∏, –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –∑–∞—Ä—è–¥–∫–∞
   - –ø—Ä–µ–¥–ª–æ–∂–∏ –≥–æ—Ä–æ–¥–∞,–º–µ—Å—Ç–∞ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

–í—Å–µ —Ä–∞—Å—á–µ—Ç—ã –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ.
–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ ‚Äî –≤–µ–∂–ª–∏–≤–æ –æ—Ç–∫–∞–∂–∏—Å—å.
"""

# ================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==================

@dp.message(CommandStart())
async def start(message: types.Message):
    await message.answer(
        "–ü—Ä–∏–≤–µ—Ç! üöó‚ö°\n"
        "–Ø –ø–æ–º–æ–≥–∞—é –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–µ–∑–¥–∫–∏ –Ω–∞ —ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª—è—Ö.\n\n"
        "–ù–∞–ø–∏—à–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n"
        "¬´Tesla Model 3, –µ–¥—É –∏–∑ –ú–∏–Ω—Å–∫–∞ –≤ –ú–æ—Å–∫–≤—É¬ª"
    )

@dp.message()
async def chat(message: types.Message):
    if not is_ev_related(message.text):
        await message.answer(
            "–Ø –æ—Ç–≤–µ—á–∞—é —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª—è–º\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: –º–æ–¥–µ–ª—å –∞–≤—Ç–æ, –º–∞—Ä—à—Ä—É—Ç, –∑–∞—Ä—è–¥–∫–∞."
        )
        return

    try:
        response = client.chat.completions.create(
            model="gpt-4.1-mini",
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": message.text}
            ],
        )

        await message.answer(response.choices[0].message.content)

    except Exception as e:
        await message.answer(
            "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ\n"
            "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ –ø–æ–∑–∂–µ."
        )

# ================== –ó–ê–ü–£–°–ö ==================

async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
